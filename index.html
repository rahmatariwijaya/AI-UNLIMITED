<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA manifest dan theme color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0b111e">
    <title>Tanya Ari Aja - Unlimited</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
         /* --- TAMBAHAN PENGEMBANGAN: CUSTOM SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* --- TAMBAHAN PENGEMBANGAN: MARKDOWN STYLES (TABLES & QUOTES) --- */
        .bubble table {
            width: 100%; border-collapse: collapse; margin: 15px 0;
            background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;
            font-size: 0.9em;
        }
        .bubble th, .bubble td {
            padding: 10px 15px; text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .bubble th {
            background: rgba(101, 179, 46, 0.15); color: var(--accent-color); font-weight: 700;
        }
        .bubble tr:last-child td { border-bottom: none; }
        .bubble tr:hover td { background: rgba(255,255,255,0.03); }
        
        .bubble blockquote {
            border-left: 4px solid var(--accent-color); margin: 15px 0;
            padding-left: 15px; color: #94a3b8; font-style: italic;
        }
        .bubble ul, .bubble ol { margin-left: 20px; margin-bottom: 10px; }
        .bubble li { margin-bottom: 5px; }
        .bubble a { color: var(--accent-color); text-decoration: none; border-bottom: 1px dotted currentColor; }
        .bubble a:hover { text-decoration: none; border-bottom: 1px solid currentColor; }

        /* --- TAMBAHAN PENGEMBANGAN: TOAST NOTIFICATION --- */
        #toast-container {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            z-index: 1000; pointer-events: none;
        }
        .toast-msg {
            background: var(--user-bubble); color: var(--text-color);
            border: 1px solid var(--accent-color); padding: 10px 20px;
            border-radius: 30px; margin-top: 10px; font-size: 0.9rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); opacity: 0;
            animation: toastUp 0.3s forwards, fadeOut 0.5s 2.5s forwards;
            display: flex; align-items: center; gap: 8px;
        }
        @keyframes toastUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* --- TEMA (DARK & LIGHT) --- */
        :root {
            /* Dark Mode (Default) */
            --bg-color: #0b1120;       
            --text-color: #f1f5f9;     
            --accent-color: #65B32E;   
            --accent-hover: #76c93b;
            --gold-color: #FFD700; /* EMAS UNLIMITED */
            --header-bg: rgba(11, 17, 32, 0.98);
            --sidebar-bg: #0b1120; 
            --user-bubble: #1e293b;        
            --border-color: #334155;
            --input-bg: #1e293b;
            --font-main: 'Inter', sans-serif;
            --font-head: 'Rajdhani', sans-serif; 
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.3);
            --code-bg: #1e1e1e;
        }

        [data-theme="light"] {
            --bg-color: #ffffff;
            --text-color: #1e293b;
            --accent-color: #65B32E;
            --accent-hover: #4d8f1e;
            --header-bg: rgba(255, 255, 255, 0.98);
            --sidebar-bg: #ffffff;
            --user-bubble: #e2e8f0;
            --border-color: #cbd5e1;
            --input-bg: #f1f5f9;
            --shadow-soft: 0 4px 15px rgba(0,0,0,0.05);
            --code-bg: #2d2d2d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%; height: 100dvh; width: 100%;
            overflow: hidden; 
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            display: flex;
            transition: background-color 0.3s, color 0.3s;
        }

        /* LAYOUT UTAMA */
        .app-layout {
            display: flex; width: 100%; height: 100%;
        }

        /* --- DASHBOARD / SIDEBAR --- */
        .sidebar {
            width: 280px; background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            padding: 20px; transition: transform 0.3s ease;
            z-index: 70; position: relative;
        }

        .sidebar-header {
            font-family: var(--font-head); font-size: 1.2rem; font-weight: 700;
            margin-bottom: 20px; color: var(--accent-color);
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
            width: 100%;
        }
        
        /* STYLE UNTUK LABEL UNLIMITED EMAS */
        .unlimited-badge {
            color: var(--gold-color);
            font-weight: 800;
            font-style: italic;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        /* Auth Section */
        .user-profile-section {
            padding-bottom: 15px; border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        #g_id_onload { display: none; }
        .google-login-wrapper { width: 100%; display: flex; justify-content: center; }
        
        .user-info-display {
            display: none; align-items: center; gap: 10px; 
            font-size: 0.9rem; color: var(--text-color);
            padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;
        }
        .user-info-display img { width: 30px; height: 30px; border-radius: 50%; }
        .btn-logout { 
            font-size: 0.75rem; color: #ef4444; background: none; border: none; 
            cursor: pointer; text-decoration: underline; margin-left: auto; 
        }

        .new-chat-btn {
            width: 100%; padding: 10px; background: var(--accent-color); color: #0b1120;
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 15px; transition: 0.2s; font-family: var(--font-head);
        }
        .new-chat-btn:hover { background: var(--accent-hover); }

        .history-container {
            flex: 1; overflow-y: auto; margin-bottom: 15px;
            padding-right: 5px;
        }
        .history-list { list-style: none; }
        .history-item {
            padding: 10px; margin-bottom: 5px; border-radius: 6px;
            cursor: pointer; color: var(--text-color); opacity: 0.8;
            font-size: 0.85rem; display: flex; align-items: center; gap: 10px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: 0.2s; border: 1px solid transparent;
        }
        .history-item:hover { background: rgba(101, 179, 46, 0.1); opacity: 1; }
        .history-item.active { 
            background: rgba(101, 179, 46, 0.15); color: var(--accent-color); 
            border-color: rgba(101, 179, 46, 0.3); font-weight: 600;
        }

        .clear-history-btn {
            font-size: 0.75rem; color: #ef4444; background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3); padding: 5px; width: 100%;
            border-radius: 6px; cursor: pointer; margin-bottom: 20px; text-align: center;
        }
        .clear-history-btn:hover { background: rgba(239, 68, 68, 0.1); }

        .sidebar-menu { list-style: none; margin-bottom: 10px; }
        .sidebar-menu li {
            padding: 10px; margin-bottom: 5px; border-radius: 8px;
            cursor: pointer; color: var(--text-color); opacity: 0.8;
            transition: 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
        }
        .sidebar-menu li:hover { background: rgba(101, 179, 46, 0.1); opacity: 1; color: var(--accent-color); }
        
        .sidebar-label {
            font-size: 0.75rem; text-transform: uppercase; color: #64748b;
            font-weight: 700; margin-bottom: 10px; margin-top: 5px; letter-spacing: 1px;
            border-top: 1px solid var(--border-color); padding-top: 15px;
        }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 60; display: none;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { display: block; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; transform: translateX(-100%); width: 85%; max-width: 300px; }
            .sidebar.open { transform: translateX(0); }
        }

        .main-content {
            flex: 1; display: flex; flex-direction: column; position: relative;
            height: 100%; overflow: hidden;
        }

        /* HEADER */
        header {
            height: 60px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            backdrop-filter: blur(10px);
            z-index: 50;
        }

        .header-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        
        .menu-btn {
            background: none; border: none; color: var(--text-color); cursor: pointer;
            display: none; 
        }
        @media (max-width: 768px) { .menu-btn { display: block; } }

        .brand-wrapper {
            display: flex; align-items: center; gap: 15px; 
            flex: 1; width: 100%;
        }
        
        .brand-title {
            font-family: var(--font-head); font-size: 1.3rem; font-weight: 700;
            letter-spacing: 1px; 
            color: var(--accent-color); 
            display: flex; align-items: center; justify-content: space-between;
            width: 100%;
            margin-right: 5px;
        }
        .brand-logo {
            width: 24px; height: 24px; border: 2px solid var(--accent-color);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 800; color: var(--accent-color);
            flex-shrink: 0; margin-right: 8px;
        }

        /* MODEL SELECTOR */
        .model-selector-container {
            position: relative;
            margin-left: auto;
            /* Hidden by default since we only have 1 model now, but kept in DOM for script compatibility */
            display: none; 
        }
        
        /* CHAT AREA */
        #chat-wrapper { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px 0; scroll-behavior: smooth; }

        .message-row {
            width: 100%; padding: 15px 20px;
            display: flex; 
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* USER STYLE */
        .message-row.user { justify-content: flex-end; }
        .message-row.user .bubble {
            background: var(--user-bubble); color: var(--text-color);
            padding: 10px 16px; border-radius: 12px 0 12px 12px;
            max-width: 80%; line-height: 1.5; font-size: 0.95rem;
            border: 1px solid var(--border-color);
        }
        .message-row.user .bubble img {
            max-width: 100%; border-radius: 8px; margin-top: 5px; display: block;
        }

        /* AI STYLE */
        .message-row.ai { 
            justify-content: flex-start; width: 100%; padding: 10px 20px; 
            border-bottom: 1px solid transparent;
        }
        .message-row.ai .message-content {
            width: 100%; max-width: 900px; margin: 0 auto;
            display: flex; gap: 15px; align-items: flex-start;
            flex-direction: column; 
        }
        .ai-row-inner { display: flex; gap: 15px; width: 100%; }

        .ai .avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--bg-color);
            border: 2px solid var(--accent-color);
            color: var(--accent-color); flex-shrink: 0; 
            display: flex; align-items: center; justify-content: center;
            margin-top: 5px;
            box-shadow: 0 0 10px rgba(101, 179, 46, 0.2);
            font-family: var(--font-head);
            font-weight: 800; 
            font-size: 16px;
        }
        
        .ai .bubble {
            background: transparent !important; border: none !important; padding: 0 !important;
            color: var(--text-color); width: 100%; line-height: 1.7; font-size: 1rem;
        }
        
        .bubble strong { color: var(--accent-color); font-weight: 700; }
        .bubble h1, .bubble h2 { margin: 20px 0 10px 0; font-weight: 700; line-height: 1.2; }
        .bubble code { 
            background: rgba(101, 179, 46, 0.1); color: var(--accent-color);
            padding: 2px 5px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 0.9em;
        }
        .bubble pre {
            background: var(--code-bg) !important; border: 1px solid var(--border-color); 
            border-radius: 8px; margin: 15px 0; overflow-x: auto; padding: 10px;
        }
        .bubble p { margin-bottom: 10px; }

        /* INPUT AREA */
        .input-container {
            flex-shrink: 0; background: var(--bg-color); 
            padding: 10px 20px 20px 20px; z-index: 50;
            display: flex; justify-content: center; flex-direction: column; align-items: center;
        }
        
        #image-preview-container {
            width: 100%; max-width: 900px; display: none; padding-bottom: 10px;
        }
        .img-preview-box {
            position: relative; display: inline-block;
        }
        .img-preview-box img {
            height: 60px; border-radius: 8px; border: 1px solid var(--accent-color);
        }
        .img-remove-btn {
            position: absolute; top: -5px; right: -5px;
            background: #ef4444; color: white; border-radius: 50%;
            width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 10px;
        }

        .input-wrapper {
            width: 100%; max-width: 900px; display: flex; align-items: flex-end;
            background: var(--input-bg); border-radius: 12px; 
            border: 1px solid var(--border-color); padding: 5px;
            box-shadow: var(--shadow-soft); transition: all 0.3s;
        }
        .input-wrapper:focus-within { border-color: var(--accent-color); }

        textarea {
            flex: 1; background: transparent; border: none; color: var(--text-color);
            padding: 12px 15px; font-family: var(--font-main); font-size: 1rem;
            resize: none; max-height: 150px; outline: none; line-height: 1.5;
        }

        .input-actions { display: flex; align-items: center; gap: 5px; padding-right: 5px; padding-left: 5px; }
        
        .icon-btn {
            background: transparent; border: none; width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: 0.2s; color: #64748b;
        }
        .icon-btn:hover { color: var(--accent-color); background: rgba(101,179,46,0.1); }
        .icon-btn.recording { color: #ef4444; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        button#send-btn {
            background: var(--accent-color); border: none; width: 40px; height: 40px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
            transition: 0.2s; margin-left: 5px;
        }
        button#send-btn svg { width: 20px; height: 20px; fill: #0b1120; }
        button#send-btn.stop { background: #ef4444; }
        button#send-btn.stop svg { fill: white; }

        /* FLOATING ACTIONS */
        .chat-floating-actions {
            position: absolute; 
            bottom: 20px; 
            width: 100%;
            pointer-events: none;
            z-index: 40;
        }

        #scroll-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--user-bubble); border: 1px solid var(--border-color);
            color: var(--accent-color); 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; pointer-events: auto; transition: 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transform: translateY(10px);
            position: absolute; left: 50%; transform: translateX(-50%) translateY(10px);
            bottom: 0;
        }
        
        #in-chat-clear-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-color); border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444; 
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; pointer-events: auto; transition: 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transform: translateY(10px);
            position: absolute; right: 20px; bottom: 0;
        }
        #in-chat-clear-btn:hover { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }
        #scroll-btn.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        #in-chat-clear-btn.show { opacity: 1; transform: translateY(0); }

        .copyright-banner {
            text-align: center; font-size: 0.7rem; color: #64748b; padding-bottom: 5px;
            background: var(--bg-color); font-family: var(--font-head); text-transform: uppercase;
        }
        
        .sidebar-footer-text {
             font-size: 0.7rem; color: #64748b; margin-top: auto; 
             font-family: var(--font-head); text-transform: uppercase; text-align: center;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; animation: fadeIn 0.2s; }
        .modal-box {
            background: var(--bg-color); width: 90%; max-width: 500px;
            padding: 25px; border-radius: 16px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-title { font-family: var(--font-head); font-size: 1.4rem; font-weight: 700; margin-bottom: 15px; color: var(--text-color); }
        .modal-input {
            width: 100%; background: var(--input-bg); border: 1px solid var(--border-color);
            color: var(--text-color); padding: 10px; border-radius: 8px; margin-bottom: 20px;
            font-family: var(--font-main); resize: vertical; min-height: 100px;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 8px; cursor: pointer; border: none; font-weight: 600; font-size: 0.9rem; }
        .btn-cancel { background: transparent; color: var(--text-color); border: 1px solid var(--border-color); }
        .btn-save { background: var(--accent-color); color: #0b1120; }

    </style>
</head>
<body>

<div class="sidebar-overlay" id="sidebar-overlay"></div>

<div class="app-layout">
    
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="display:flex; align-items:center;">
                <div class="brand-logo">A</div> TANYA ARI AJA
            </div>
            <div class="unlimited-badge">UNLIMITED</div>
        </div>
        
        <div class="user-profile-section">
            <div id="g_id_onload"
                 data-client_id="572638361922-g60a1l4vra70aqif0pvm9vogu377a8ug.apps.googleusercontent.com" 
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false"
                 data-theme="outline">
            </div>
            
            <div class="google-login-wrapper" id="google-btn-wrapper">
                <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-theme="outline" data-text="signin_with" data-size="large" data-logo_alignment="left" data-width="240"></div>
            </div>

            <div class="user-info-display" id="user-info">
                <img id="user-avatar" src="" alt="Profile">
                <div style="flex:1; overflow:hidden;">
                    <div id="user-name" style="font-weight:700; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;"></div>
                    <button class="btn-logout" id="logout-btn">Keluar</button>
                </div>
            </div>
        </div>

        <button class="new-chat-btn" id="new-chat-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Chat Baru
        </button>

        <div class="sidebar-label">Riwayat Percakapan</div>
        <div class="history-container">
            <ul class="history-list" id="history-list">
                </ul>
        </div>
        <button class="clear-history-btn" id="clear-history-btn">Hapus Riwayat di Sini</button>

        <div class="sidebar-label">Pengaturan & Tampilan</div>
        <ul class="sidebar-menu">
            <li id="theme-toggle-sidebar">
                <svg id="sidebar-theme-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                Mode Gelap/Terang
            </li>
            <li id="settings-sidebar-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                Instruksi & Persona
            </li>
        </ul>

        <div class="sidebar-footer-text">Copyright Tanya Ari Aja 2025</div>
    </nav>

    <div class="main-content">
        <header>
            <div class="header-left">
                <button class="menu-btn" id="toggle-sidebar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                
                <div class="brand-wrapper">
                    <div class="brand-title">
                        <div style="display:flex; align-items:center;">
                            <div class="brand-logo">A</div> TANYA ARI AJA
                        </div>
                        <span class="unlimited-badge">UNLIMITED</span>
                    </div>
                    
                    <div class="model-selector-container">
                        <button class="current-model-btn" id="model-trigger-btn">
                            <span id="current-model-text">Loading...</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                        <div class="model-dropdown-menu" id="model-dropdown">
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div id="chat-wrapper">
            <div id="chat-container"></div>
            
            <div class="chat-floating-actions">
                <div id="scroll-btn" title="Ke Bawah">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>

                <div id="in-chat-clear-btn" title="Bersihkan Chat Saat Ini">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </div>
            </div>
        </div>

        <div class="copyright-banner">&copy; TANYA ARI AJA 2025</div>

        <div class="input-container">
            <div id="image-preview-container">
                <div class="img-preview-box">
                    <img id="image-preview" src="" alt="Preview">
                    <div class="img-remove-btn" id="remove-img-btn">âœ•</div>
                </div>
            </div>

            <div class="input-wrapper">
                <div class="input-actions">
                    <input type="file" id="image-input" accept="image/*" hidden>
                    <button class="icon-btn" id="upload-btn" title="Kirim Gambar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </button>
                    <button class="icon-btn" id="mic-btn" title="Pesan Suara">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    </button>
                </div>

                <textarea id="user-input" placeholder="Ketik atau bicara..." rows="1"></textarea>
                
                <button id="send-btn">
                    <svg viewBox="0 0 24 24" id="btn-icon"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settings-modal">
    <div class="modal-box">
        <div class="modal-title">Pengaturan Persona Ari</div>
        <textarea id="system-prompt-input" class="modal-input"></textarea>
        <div class="modal-actions">
            <button class="btn btn-cancel" id="close-settings">Batal</button>
            <button class="btn btn-save" id="save-settings">Simpan</button>
        </div>
    </div>
</div>

<script>
    // --- GOOGLE AUTHENTICATION LOGIC ---
    function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    function handleCredentialResponse(response) {
        try {
            const responsePayload = parseJwt(response.credential);
            const userData = {
                name: responsePayload.name,
                picture: responsePayload.picture,
                email: responsePayload.email
            };
            localStorage.setItem('ari_user', JSON.stringify(userData));
            updateAuthUI(userData);
            console.log("Login Google Berhasil ID: " + responsePayload.sub);
        } catch (e) {
            console.error("Gagal memproses login Google", e);
        }
    }

    function updateAuthUI(user) {
        const btnWrapper = document.getElementById('google-btn-wrapper');
        const userInfo = document.getElementById('user-info');
        const userImg = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');

        if (user) {
            btnWrapper.style.display = 'none';
            userInfo.style.display = 'flex';
            userImg.src = user.picture;
            userName.textContent = user.name;
        } else {
            btnWrapper.style.display = 'flex';
            userInfo.style.display = 'none';
        }
    }

    // --- MAIN LOGIC ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG & KEYS ---
        const API_URL = "https://tanyaariaja.infinityfreeapp.com/api.php"; 
        
        let modelData = []; 
        let currentModel = ""; 

        // --- DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const btnIcon = document.getElementById('btn-icon');
        
        const modelTriggerBtn = document.getElementById('model-trigger-btn');
        const modelDropdown = document.getElementById('model-dropdown');
        const currentModelText = document.getElementById('current-model-text');
        
        const scrollBtn = document.getElementById('scroll-btn');
        const inChatClearBtn = document.getElementById('in-chat-clear-btn');
        
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const themeBtn = document.getElementById('theme-toggle-sidebar');
        const themeIcon = document.getElementById('sidebar-theme-icon');
        const htmlTag = document.documentElement;

        const newChatBtn = document.getElementById('new-chat-btn');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        const settingsBtn = document.getElementById('settings-sidebar-btn');
        const settingsModal = document.getElementById('settings-modal');
        const systemPromptInput = document.getElementById('system-prompt-input');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');

        const uploadBtn = document.getElementById('upload-btn');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImgBtn = document.getElementById('remove-img-btn');
        const micBtn = document.getElementById('mic-btn');

        const logoutBtn = document.getElementById('logout-btn');

        // --- FETCH CONFIG ---
        async function initSystem() {
            try {
                const response = await fetch('api.php?mode=config');
                const data = await response.json();
                
                if (Array.isArray(data) && data.length > 0) {
                    modelData = data;
                    currentModel = modelData[0].id;
                    renderModelDropdown();
                    currentModelText.textContent = modelData[0].name;
                } else {
                    console.error("Gagal memuat model dari backend.");
                    currentModelText.textContent = "Error Loading";
                }
            } catch (error) {
                console.error("Koneksi ke api.php gagal:", error);
                currentModelText.textContent = "Offline Mode";
            }
            initChat();
        }

        const savedUser = localStorage.getItem('ari_user');
        if (savedUser) {
            updateAuthUI(JSON.parse(savedUser));
        }

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('ari_user');
            updateAuthUI(null);
            window.location.reload(); 
        });

        // --- TEMA LOGIC ---
        let isDark = localStorage.getItem('ari_theme') !== 'light'; 
        function updateTheme() {
            htmlTag.setAttribute('data-theme', isDark ? 'dark' : 'light');
            if(isDark) {
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            } else {
                themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            }
            localStorage.setItem('ari_theme', isDark ? 'dark' : 'light');
        }
        updateTheme();
        themeBtn.addEventListener('click', () => { isDark = !isDark; updateTheme(); });

        // --- DROPDOWN MODEL ---
        function renderModelDropdown() {
            modelDropdown.innerHTML = '';
            modelData.forEach(m => {
                const item = document.createElement('div');
                item.className = 'model-option';
                if (m.name === currentModelText.textContent) item.classList.add('selected');
                item.textContent = m.name;
                
                item.onclick = () => {
                    currentModel = m.id;
                    currentModelText.textContent = m.name;
                    modelDropdown.classList.remove('active');
                    appendToScreen('system', `Mode dialihkan ke: ${m.name}`);
                    document.querySelectorAll('.model-option').forEach(el => el.classList.remove('selected'));
                    item.classList.add('selected');
                };
                modelDropdown.appendChild(item);
            });
        }
        
        modelTriggerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            modelDropdown.classList.toggle('active');
        });
        
        document.addEventListener('click', (e) => {
            if (!modelTriggerBtn.contains(e.target) && !modelDropdown.contains(e.target)) {
                modelDropdown.classList.remove('active');
            }
        });

        // --- SIDEBAR ---
        function openSidebar() { sidebar.classList.add('open'); sidebarOverlay.classList.add('active'); }
        function closeSidebar() { sidebar.classList.remove('open'); sidebarOverlay.classList.remove('active'); }
        toggleSidebarBtn.addEventListener('click', openSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // --- SYSTEM PROMPT ---
        let defaultSystemPrompt = "Kamu adalah Ari, asisten AI yang cerdas. Jawab dalam bahasa Indonesia yang baik, ramah, dan membantu.";
        let currentSystemPrompt = localStorage.getItem('ari_system_prompt') || defaultSystemPrompt;

        // --- CHAT HISTORY ---
        let allSessions = JSON.parse(localStorage.getItem('ari_chat_history') || '{}');
        let currentSessionId = localStorage.getItem('ari_current_session_id') || null;

        marked.setOptions({ breaks: true, gfm: true });

        function initChat() {
            renderHistoryList();
            if (currentSessionId && allSessions[currentSessionId]) {
                loadMessagesToUI(allSessions[currentSessionId].messages);
            } else {
                createNewChat(false); 
            }
        }

        function createNewChat(clearUI = true) {
            const id = 'sess_' + Date.now();
            currentSessionId = id;
            localStorage.setItem('ari_current_session_id', id);
            
            allSessions[id] = {
                title: 'Percakapan Baru',
                messages: [{ role: "system", content: currentSystemPrompt }],
                timestamp: Date.now()
            };
            saveHistory();

            if (clearUI) {
                chatContainer.innerHTML = '';
                showWelcomeMessage();
                closeSidebar();
            } else if (chatContainer.innerHTML.trim() === '') {
                showWelcomeMessage();
            }
            updateFloatingButtons(); 
            renderHistoryList();
        }

        function saveHistory() {
            localStorage.setItem('ari_chat_history', JSON.stringify(allSessions));
            renderHistoryList();
        }

        function renderHistoryList() {
            historyList.innerHTML = '';
            const sortedIds = Object.keys(allSessions).sort((a,b) => allSessions[b].timestamp - allSessions[a].timestamp);
            
            sortedIds.forEach(id => {
                const session = allSessions[id];
                const li = document.createElement('li');
                li.className = 'history-item';
                if(id === currentSessionId) li.classList.add('active');
                li.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2-2z"></path></svg> ${session.title}`;
                li.onclick = () => loadSession(id);
                historyList.appendChild(li);
            });
        }

        function loadSession(id) {
            currentSessionId = id;
            localStorage.setItem('ari_current_session_id', id);
            chatContainer.innerHTML = '';
            loadMessagesToUI(allSessions[id].messages);
            renderHistoryList();
            closeSidebar();
            setTimeout(scrollToBottom, 100);
        }

        function loadMessagesToUI(messages) {
            chatContainer.innerHTML = '';
            let hasMessages = false;
            messages.forEach(msg => {
                if(msg.role === 'system') return;
                hasMessages = true;
                
                let contentText = '';
                let imageUrl = null;

                if (Array.isArray(msg.content)) {
                    msg.content.forEach(part => {
                        if(part.type === 'text') contentText = part.text;
                        if(part.type === 'image_url') imageUrl = part.image_url.url;
                    });
                } else {
                    contentText = msg.content;
                }
                appendToScreen(msg.role, contentText, true, imageUrl);
            });
            if(!hasMessages) showWelcomeMessage();
            updateFloatingButtons();
        }

        function updateSessionTitle(text) {
            if(allSessions[currentSessionId] && allSessions[currentSessionId].title === 'Percakapan Baru') {
                allSessions[currentSessionId].title = text.substring(0, 30) + (text.length>30?'...':'');
                saveHistory();
            }
        }

        newChatBtn.addEventListener('click', () => createNewChat(true));
        
        clearHistoryBtn.addEventListener('click', () => {
            if(confirm('Hapus semua riwayat chat dari sidebar?')) {
                allSessions = {};
                localStorage.removeItem('ari_chat_history');
                createNewChat(true);
            }
        });

        inChatClearBtn.addEventListener('click', () => {
            if(confirm('Bersihkan percakapan saat ini saja?')) {
                allSessions[currentSessionId].messages = [{ role: "system", content: currentSystemPrompt }];
                saveHistory();
                chatContainer.innerHTML = '';
                showWelcomeMessage();
                updateFloatingButtons();
            }
        });

        // --- IMAGE & VOICE ---
        let currentImageBase64 = null;
        uploadBtn.addEventListener('click', () => imageInput.click());
        
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageBase64 = e.target.result;
                    imagePreview.src = currentImageBase64;
                    imagePreviewContainer.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        });
        removeImgBtn.addEventListener('click', () => {
            currentImageBase64 = null; imageInput.value = ''; imagePreviewContainer.style.display = 'none';
        });

        let recognition;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => { micBtn.classList.add('recording'); };
            recognition.onend = () => { micBtn.classList.remove('recording'); };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value += (userInput.value ? ' ' : '') + transcript;
                userInput.style.height = 'auto';
                userInput.style.height = Math.min(userInput.scrollHeight, 150) + 'px';
                updateButtonState();
            };
        }
        micBtn.addEventListener('click', () => {
            if (!recognition) { alert("Browser Anda tidak mendukung fitur suara."); return; }
            micBtn.classList.contains('recording') ? recognition.stop() : recognition.start();
        });

        // --- UI HELPERS ---
        function showWelcomeMessage() {
            appendToScreen('ai', 'Halo! Saya Ari Unlimited. Ada yang bisa saya bantu hari ini?', true);
        }

        function scrollToBottom() {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        let userScrolledUp = false;

        function updateFloatingButtons() {
            const distanceToBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight;
            
            // PENTING: Logika ini mendeteksi jika user sedang melihat konten di atas
            if (distanceToBottom > 50) { 
                userScrolledUp = true;
                scrollBtn.classList.add('show');
            } else {
                userScrolledUp = false;
                scrollBtn.classList.remove('show');
            }

            const msgCount = chatContainer.querySelectorAll('.message-row').length;
            if (msgCount > 1) {
                inChatClearBtn.classList.add('show');
            } else {
                inChatClearBtn.classList.remove('show');
            }
        }

        chatContainer.addEventListener('scroll', updateFloatingButtons);
        scrollBtn.addEventListener('click', () => {
             userScrolledUp = false; 
             scrollToBottom();
        });

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            updateButtonState();
        });

        // --- SETTINGS ---
        settingsBtn.addEventListener('click', () => {
            systemPromptInput.value = currentSystemPrompt;
            settingsModal.classList.add('open');
            closeSidebar();
        });
        closeSettings.addEventListener('click', () => settingsModal.classList.remove('open'));
        saveSettings.addEventListener('click', () => {
            const newPrompt = systemPromptInput.value.trim();
            if (newPrompt) {
                currentSystemPrompt = newPrompt;
                localStorage.setItem('ari_system_prompt', currentSystemPrompt);
                
                if(allSessions[currentSessionId]) {
                    allSessions[currentSessionId].messages[0].content = currentSystemPrompt;
                    saveHistory();
                }
                settingsModal.classList.remove('open');
            }
        });

        // --- SEND LOGIC ---
        let abortController = null;
        let isGenerating = false;

        function updateButtonState() {
            if (isGenerating) {
                sendBtn.classList.add('stop', 'active');
                btnIcon.innerHTML = '<rect x="6" y="6" width="12" height="12"></rect>'; 
            } else {
                sendBtn.classList.remove('stop');
                if (userInput.value.trim().length > 0 || currentImageBase64) {
                    sendBtn.classList.add('active');
                    btnIcon.innerHTML = '<path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>';
                } else {
                    sendBtn.classList.remove('active');
                    btnIcon.innerHTML = '<path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>';
                }
            }
        }

        function appendToScreen(role, text, isHtml = false, imageUrl = null) {
            const rowDiv = document.createElement('div');
            rowDiv.classList.add('message-row', role === 'system' ? 'ai' : role);
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');

            if (role === 'ai' || role === 'system') {
                const aiInner = document.createElement('div');
                aiInner.className = 'ai-row-inner';
                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar');
                
                // --- LOGO BRANDING ---
                avatarDiv.textContent = "A";
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.classList.add('bubble');
                if (isHtml) bubbleDiv.innerHTML = text; else bubbleDiv.textContent = text;
                
                aiInner.appendChild(avatarDiv); aiInner.appendChild(bubbleDiv);
                contentDiv.appendChild(aiInner);
                
                if(isHtml) setTimeout(() => enhanceCodeBlocks(bubbleDiv), 0);
            } else {
                const bubbleDiv = document.createElement('div');
                bubbleDiv.classList.add('bubble');
                bubbleDiv.textContent = text;
                if(imageUrl) {
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    bubbleDiv.appendChild(img);
                }
                contentDiv.appendChild(bubbleDiv);
            }

            rowDiv.appendChild(contentDiv);
            chatContainer.appendChild(rowDiv);
            
            if (!userScrolledUp) {
                setTimeout(scrollToBottom, 50);
            }
            updateFloatingButtons();
            
            if(role === 'ai') return contentDiv.querySelector('.bubble');
            return null;
        }

        function enhanceCodeBlocks(element) {
            if(!element) return;
            element.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            element.querySelectorAll('pre').forEach((pre) => {
                if (pre.querySelector('.code-header')) return;
                const wrapper = document.createElement('div');
                wrapper.className = 'code-header';
                wrapper.innerHTML = `<span>Code</span><span style="font-size:0.7em; cursor:pointer;" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText); alert('Tersalin!')">Salin</span>`;
                pre.insertBefore(wrapper, pre.firstChild);
            });
        }

        async function smartTypeWriter(element, markdownText) {
            let htmlContent = marked.parse(markdownText);
            element.innerHTML = ""; 
            const tokens = htmlContent.split(/(<[^>]*>)/g).filter(t => t !== "");
            let tokenIndex = 0;
            const wait = ms => new Promise(res => setTimeout(res, ms));

            while (tokenIndex < tokens.length) {
                if (!isGenerating) { element.innerHTML = htmlContent; break; }
                const token = tokens[tokenIndex];
                if (token.startsWith('<')) {
                    element.innerHTML += token; 
                } else {
                    const chars = token.split('');
                    for (let i = 0; i < chars.length; i++) {
                        if (!isGenerating) break;
                        element.innerHTML += chars[i];
                        
                        // FIX SCROLL: Hanya scroll otomatis JIKA user TIDAK sedang scroll ke atas
                        if(i % 5 === 0 && !userScrolledUp) scrollToBottom(); 
                        
                        await wait(1); 
                    }
                }
                tokenIndex++;
            }
            enhanceCodeBlocks(element);
            if (!userScrolledUp) scrollToBottom();
            updateFloatingButtons();
        }

        async function handleSend() {
            if (isGenerating) {
                if (abortController) abortController.abort();
                isGenerating = false;
                const loadingEl = document.getElementById('loading-bubble');
                if(loadingEl) loadingEl.remove();
                appendToScreen('system', "Dihentikan.");
                updateButtonState();
                return;
            }

            const text = userInput.value.trim();
            const hasImage = !!currentImageBase64;
            if (!text && !hasImage) return;

            isGenerating = true;
            userScrolledUp = false; 
            abortController = new AbortController();
            updateButtonState();

            appendToScreen('user', text, false, currentImageBase64);
            updateSessionTitle(text || "Gambar");
            scrollToBottom(); 

            let msgContent = hasImage ? [
                { type: "text", text: text || "Jelaskan gambar ini." },
                { type: "image_url", image_url: { url: currentImageBase64 } }
            ] : text;

            const userMsg = { role: "user", content: msgContent };
            allSessions[currentSessionId].messages.push(userMsg);
            saveHistory();

            userInput.value = ''; userInput.style.height = 'auto';
            currentImageBase64 = null;
            imagePreviewContainer.style.display = 'none';

            const loadingRow = document.createElement('div');
            loadingRow.classList.add('message-row', 'ai');
            loadingRow.id = 'loading-bubble';
            loadingRow.innerHTML = `<div class="message-content"><div class="ai-row-inner"><div class="avatar">A</div><div class="bubble"><em>Ari sedang berpikir...</em></div></div></div>`;
            chatContainer.appendChild(loadingRow);
            scrollToBottom();

            try {
                const historyToSend = allSessions[currentSessionId].messages.map(msg => {
                    if(Array.isArray(msg.content) && !msg.content.some(c=>c.type==='image_url')) {
                         return { role: msg.role, content: msg.content[0].text };
                    }
                    return msg;
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: currentModel, 
                        messages: historyToSend,
                        stream: true // Minta mode streaming
                    }),
                    signal: abortController.signal
                });

                document.getElementById('loading-bubble').remove();
                
                const aiBubble = appendToScreen('ai', ''); 
                let fullReply = "";
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataText = line.replace('data: ', '').trim();
                            if (dataText === '[DONE]') break;
                            
                            try {
                                const parsed = JSON.parse(dataText);
                                const delta = parsed.choices[0].delta.content || "";
                                fullReply += delta;
                                
                                // Render markdown secara real-time
                                aiBubble.innerHTML = marked.parse(fullReply);
                                
                                if (!userScrolledUp) scrollToBottom();
                            } catch (e) {}
                        }
                    }
                }
                
                enhanceCodeBlocks(aiBubble);
                allSessions[currentSessionId].messages.push({ role: "assistant", content: fullReply });
                saveHistory();

            } catch (err) {
                if (err.name !== 'AbortError') {
                    if(document.getElementById('loading-bubble')) document.getElementById('loading-bubble').remove();
                    appendToScreen('system', "Error: " + err.message);
                }
            } finally {
                isGenerating = false;
                updateButtonState();
                updateFloatingButtons();
            }
        }    

        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
        });

        initSystem();
    });
            
            // --- TAMBAHAN PENGEMBANGAN: FUNGSI TOAST ---
    function showToast(message) {
        const container = document.getElementById('toast-container');
        if(!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast-msg';
        toast.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent-color')}" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg> ${message}`;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 3000);
    }

    // Override fungsi copy clipboard agar menggunakan Toast, bukan Alert
    // Kita menimpa logika onclick string di dalam fungsi enhanceCodeBlocks tanpa menghapus kode lama
    const originalEnhance = enhanceCodeBlocks;
    enhanceCodeBlocks = function(element) {
        if(!element) return;
        element.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
        element.querySelectorAll('pre').forEach((pre) => {
            if (pre.querySelector('.code-header')) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'code-header';
            // Perhatikan penggunaan showToast() menggantikan alert()
            wrapper.innerHTML = `<span>Code</span><span style="font-size:0.7em; cursor:pointer;" onclick="navigator.clipboard.writeText(this.parentElement.nextElementSibling.innerText); if(typeof showToast === 'function') { showToast('Kode Berhasil Disalin!'); } else { alert('Tersalin!'); }">Salin</span>`;
            pre.insertBefore(wrapper, pre.firstChild);
        });
    };

      
</script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('/sw.js');
        console.log('SW terdaftar!', reg);

        // Meminta izin Notifikasi
        if (Notification.permission === 'default') {
          await Notification.requestPermission();
        }

        // Mendaftarkan Periodic Sync (jika didukung)
        if ('periodicSync' in reg) {
          const status = await navigator.permissions.query({
            name: 'periodic-background-sync',
          });
          if (status.state === 'granted') {
            await reg.periodicSync.register('update-check', {
              minInterval: 24 * 60 * 60 * 1000, // 24 jam
            });
          }
        }
      } catch (err) {
        console.log('Registrasi gagal:', err);
      }
    });
  }
</script>
</body>
</html>
